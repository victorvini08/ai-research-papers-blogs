{% extends "base.html" %}

{% block title %}Archive - AI Research Papers Daily{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-2">
                        <i class="fas fa-archive me-2"></i>Daily Summaries Archive
                    </h1>
                    <p class="text-muted mb-0">
                        Browse all our daily AI research paper summaries
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="generateSummary()">
                        <i class="fas fa-magic me-2"></i>Generate Today's Summary
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h3 class="text-primary fw-bold">{{ summaries|length }}</h3>
                            <p class="text-muted mb-0">Total Summaries</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-success fw-bold">
                                {% set total_papers = summaries|sum(attribute='paper_count') %}
                                {{ total_papers }}
                            </h3>
                            <p class="text-muted mb-0">Total Papers</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-info fw-bold">
                                {% if summaries %}
                                {{ (total_papers / summaries|length)|round(1) }}
                                {% else %}
                                0
                                {% endif %}
                            </h3>
                            <p class="text-muted mb-0">Avg Papers/Day</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-warning fw-bold">
                                {% if summaries %}
                                {{ summaries[0].date }}
                                {% else %}
                                N/A
                                {% endif %}
                            </h3>
                            <p class="text-muted mb-0">Latest Summary</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Search summaries by date...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                <select class="form-select" id="sortSelect">
                                    <option value="date-desc">Newest First</option>
                                    <option value="date-asc">Oldest First</option>
                                    <option value="papers-desc">Most Papers First</option>
                                    <option value="papers-asc">Least Papers First</option>
                                </select>
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summaries List -->
    {% if summaries %}
    <div class="row" id="summariesContainer">
        {% for summary in summaries %}
        <div class="col-12 mb-3 summary-item" 
             data-date="{{ summary.date }}" 
             data-papers="{{ summary.paper_count }}">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="mb-0 me-3">
                                    <i class="fas fa-calendar-day me-2 text-primary"></i>
                                    {{ summary.date }}
                                </h5>
                                <span class="badge bg-primary fs-6">{{ summary.paper_count }} papers</span>
                            </div>
                            <p class="text-muted mb-2">
                                <i class="fas fa-clock me-1"></i>
                                Generated on {{ summary.created_at.split(' ')[0] if summary.created_at else 'Unknown' }}
                            </p>
                            <p class="mb-0">
                                Daily summary of AI research papers published on {{ summary.date }}. 
                                Click to view the full summary and browse all papers from this date.
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('daily_summary', date=summary.date) }}" 
                                   class="btn btn-primary">
                                    <i class="fas fa-eye me-2"></i>View Summary
                                </a>
                                <button class="btn btn-outline-secondary btn-sm" 
                                        onclick="generateSummary('{{ summary.date }}')">
                                    <i class="fas fa-sync-alt me-1"></i>Regenerate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Summaries pagination">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Pagination will be generated by JavaScript -->
                </ul>
            </nav>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="card text-center py-5">
                <div class="card-body">
                    <i class="fas fa-archive fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted mb-3">No Summaries Found</h4>
                    <p class="text-muted mb-4">
                        No daily summaries have been generated yet. Start by fetching some papers and generating a summary.
                    </p>
                    <div class="d-flex gap-3 justify-content-center">
                        <button class="btn btn-primary" onclick="fetchPapers()">
                            <i class="fas fa-sync-alt me-2"></i>Fetch Papers
                        </button>
                        <button class="btn btn-outline-primary" onclick="generateSummary()">
                            <i class="fas fa-magic me-2"></i>Generate Summary
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
const itemsPerPage = 10;
let filteredItems = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeItems();
    setupEventListeners();
    updatePagination();
});

function initializeItems() {
    const items = document.querySelectorAll('.summary-item');
    filteredItems = Array.from(items);
}

function setupEventListeners() {
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
        filterItems();
    });

    // Sort functionality
    document.getElementById('sortSelect').addEventListener('change', function(e) {
        sortItems();
    });
}

function filterItems() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    filteredItems = Array.from(document.querySelectorAll('.summary-item')).filter(item => {
        const date = item.dataset.date.toLowerCase();
        return date.includes(searchTerm);
    });
    
    currentPage = 1;
    displayItems();
    updatePagination();
}

function sortItems() {
    const sortBy = document.getElementById('sortSelect').value;
    
    filteredItems.sort((a, b) => {
        switch(sortBy) {
            case 'date-desc':
                return new Date(b.dataset.date) - new Date(a.dataset.date);
            case 'date-asc':
                return new Date(a.dataset.date) - new Date(b.dataset.date);
            case 'papers-desc':
                return parseInt(b.dataset.papers) - parseInt(a.dataset.papers);
            case 'papers-asc':
                return parseInt(a.dataset.papers) - parseInt(b.dataset.papers);
            default:
                return 0;
        }
    });
    
    currentPage = 1;
    displayItems();
    updatePagination();
}

function displayItems() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const itemsToShow = filteredItems.slice(startIndex, endIndex);
    
    // Hide all items
    document.querySelectorAll('.summary-item').forEach(item => {
        item.style.display = 'none';
    });
    
    // Show filtered items
    itemsToShow.forEach(item => {
        item.style.display = 'block';
    });
}

function updatePagination() {
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }
    
    pagination.style.display = 'flex';
    pagination.innerHTML = '';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayItems();
        updatePagination();
    }
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('sortSelect').value = 'date-desc';
    filterItems();
    sortItems();
}
</script>
{% endblock %} 